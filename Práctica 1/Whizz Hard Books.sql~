CREATE DATABASE HardBooks
USE HardBooks

CREATE TABLE CLIENTE (
	carne INT NOT NULL,
	nombre VARCHAR(50) NOT NULL,
	dpi INT NOT NULL,
	direccion VARCHAR(100) NOT NULL,
	telefono INT NOT NULL
)
CREATE TABLE LIBRO (
	id INT NOT NULL,
	titulo VARCHAR(50) NOT NULL,
	existencias INT NOT NULL,
	paginas INT NOT NULL,
	tema VARCHAR(50) NOT NULL,
	autor VARCHAR(50) NOT NULL
)
CREATE TABLE PRESTAMO (
	id INT NOT NULL IDENTITY (1,1),
	fecha_prestamo DATETIME NOT NULL,
	fecha_devolucion DATETIME NULL,
	cliente INT NOT NULL,
	libro INT NOT NULL,
)
CREATE TABLE RESERVA (
	id INT NOT NULL IDENTITY (1,1),
	fecha_reserva DATETIME NOT NULL,
	cliente INT NOT NULL,
	libro INT NOT NULL,
)
GO
ALTER TABLE CLIENTE ADD PRIMARY KEY (carne)
ALTER TABLE LIBRO ADD PRIMARY KEY (id)
ALTER TABLE PRESTAMO ADD PRIMARY KEY (id)
ALTER TABLE RESERVA ADD PRIMARY KEY (id)
GO
ALTER TABLE PRESTAMO ADD FOREIGN KEY (cliente) REFERENCES CLIENTE (carne)
ALTER TABLE PRESTAMO ADD FOREIGN KEY (libro) REFERENCES LIBRO (id)
ALTER TABLE RESERVA ADD FOREIGN KEY (cliente) REFERENCES CLIENTE (carne)
ALTER TABLE RESERVA ADD FOREIGN KEY (libro) REFERENCES LIBRO (id)
GO

SELECT * FROM LIBRO
SELECT * FROM CLIENTE
SELECT * FROM PRESTAMO
SELECT * FROM RESERVA
SELECT COUNT(fecha_devolucion) FROM PRESTAMO
INSERT INTO LIBRO VALUES (101, 'El Evangelio Según Jesucristo', 12, 483, 'Religión', 'José Saramago')
INSERT INTO LIBRO VALUES (104, 'Romeo y Julieta', 10, 483, 'Romance', 'Shakespeare')
SET DATEFORMAT DMY
INSERT INTO PRESTAMO VALUES ('11/06/2015 00:30:00.00', NULL, 201222591, 101)
INSERT INTO PRESTAMO VALUES ('14/06/2015', '15/06/2015', 201222591, 101)
INSERT INTO RESERVA VALUES ((SELECT GETDATE()), 201222591, 4)
INSERT INTO RESERVA VALUES ((SELECT GETDATE()), 201222591, 4)

SELECT DISTINCT titulo AS 'Título', autor AS 'Autor', existencias AS 'Existencias', existencias-(SELECT COUNT(*) FROM PRESTAMO WHERE PRESTAMO.libro = LIBRO.id AND PRESTAMO.fecha_devolucion IS NULL) AS 'Disponibles', (SELECT COUNT(*) FROM PRESTAMO WHERE PRESTAMO.libro = LIBRO.id AND PRESTAMO.fecha_devolucion IS NULL) AS 'Prestados', (SELECT COUNT(*) FROM RESERVA WHERE RESERVA.libro = LIBRO.id) AS 'Reservados' FROM LIBRO, PRESTAMO, RESERVA WHERE LIBRO.id = PRESTAMO.libro OR LIBRO.id != PRESTAMO.libro


SELECT DISTINCT LIBRO.id, titulo, (SELECT COUNT(RESERVA.id) FROM RESERVA WHERE RESERVA.libro = LIBRO.id) FROM RESERVA, LIBRO

SELECT COUNT(*) FROM PRESTAMO WHERE PRESTAMO.fecha_devolucion IS NULL
GROUP BY cliente 



DELETE FROM PRESTAMO
DELETE FROM RESERVA

SELECT COUNT(*) FROM PRESTAMO, LIBRO WHERE PRESTAMO.libro = LIBRO.id AND PRESTAMO.fecha_devolucion IS NULL

SELECT COUNT(*) FROM PRESTAMO, CLIENTE WHERE CLIENTE.carne = 201222591 AND PRESTAMO.fecha_devolucion IS NULL


UPDATE PRESTAMO SET fecha_devolucion = GETDATE() WHERE PRESTAMO.libro = 101
UPDATE LIBRO SET existencias = 0 WHERE id = 101

SELECT existencias-(SELECT COUNT(*) FROM PRESTAMO WHERE PRESTAMO.libro = LIBRO.id AND PRESTAMO.fecha_devolucion IS NULL) FROM LIBRO

SELECT * FROM PRESTAMO WHERE cliente = 201222591 AND libro = 4 AND  fecha_devolucion IS NULL

SELECT (SELECT titulo from LIBRO WHERE id = libro) AS 'Título', COUNT(*) AS 'Veces prestado' FROM PRESTAMO GROUP BY libro ORDER BY 'Veces Prestado' DESC